@page "/topics/detail"
@inject IJSRuntime JS

<PageTitle>Topic — StudyHub</PageTitle>

<div class="bg-gray-50 font-sans min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <i data-feather="book-open" class="text-blue-500 h-8 w-8"></i>
                        <span class="ml-2 text-xl font-semibold text-gray-900">StudyHub</span>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="/dashboard" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Dashboard</a>
                        <a href="/modules" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Modules</a>
                        <a href="/resources" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Resources</a>
                        <a href="/messages" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Messages</a>
                    </div>
                </div>
                <div class="hidden sm:ml-6 sm:flex sm:items-center">
                    <button type="button" class="bg-white p-1 rounded-full text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 relative">
                        <span class="sr-only">View notifications</span>
                        <i data-feather="bell"></i>
                        <span class="notification-dot bg-red-500 rounded-full"></span>
                    </button>

                    <div class="ml-3 relative">
                        <div>
                            <button type="button" class="bg-white rounded-full flex text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" id="user-menu-button" aria-expanded="false" aria-haspopup="true">
                                <span class="sr-only">Open user menu</span>
                                <img class="h-8 w-8 rounded-full" src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?auto=format&fit=facearea&facepad=2&w=256&h=256&q=80" alt="">
                            </button>
                        </div>
                    </div>
                </div>
                <div class="-mr-2 flex items-center sm:hidden">
                    <button type="button"
                            class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500"
                            aria-controls="mobile-menu"
                            aria-expanded="false">
                        <span class="sr-only">Open main menu</span>
                        <i data-feather="menu"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile menu -->
        <div id="mobile-menu" class="sm:hidden hidden">
            <div class="pt-2 pb-3 space-y-1">
                <a href="/dashboard" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-gray-300">Dashboard</a>
                <a href="/modules" class="block pl-3 pr-4 py-2 border-l-4 border-blue-500 bg-blue-50 text-blue-700 text-base font-medium">Modules</a>
                <a href="/resources" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-gray-300">Resources</a>
                <a href="/messages" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-gray-300">Messages</a>
            </div>
        </div>
    </nav>

    <!-- Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="lg:grid lg:grid-cols-12 lg:gap-6">
            <!-- Main thread -->
            <section class="lg:col-span-9">
                <div class="bg-white shadow rounded-lg overflow-hidden">
                    <!-- Header -->
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                        <div class="flex flex-wrap items-center gap-3">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800" id="topic-status">Active</span>
                            <h1 class="text-xl font-semibold text-gray-900 flex-1">Understanding Recursion in CS101</h1>
                        </div>
                        <div class="mt-3 flex flex-wrap items-center gap-4 text-sm text-gray-500">
                            <span class="inline-flex items-center"><i data-feather="user" class="mr-1 h-4 w-4"></i> Jane Smith</span>
                            <span class="inline-flex items-center"><i data-feather="clock" class="mr-1 h-4 w-4"></i> 2 hours ago</span>
                            <span class="inline-flex items-center"><i data-feather="message-square" class="mr-1 h-4 w-4"></i><span id="reply-count">12</span> replies</span>
                            <span class="inline-flex items-center"><i data-feather="book" class="mr-1 h-4 w-4"></i> CS101</span>
                            <div class="ml-auto flex items-center gap-2">
                                <button class="btn-secondary follow-btn" @onclick="SubscribeCurrentTopic" disabled="@subscribing" title="Subscribe">
                                    <i data-feather="star" class="mr-1 h-4 w-4"></i> @(subscribing ? "Subscribing…" : "Subscribe")
                                </button>
                                <button class="btn-secondary" title="Share">
                                    <i data-feather="share-2" class="mr-1 h-4 w-4"></i> Share
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Question post -->
                    <article class="p-6 post-card" id="post-question" data-post-id="q1">
                        <div class="flex">
                            <img class="h-10 w-10 rounded-full" src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=facearea&w=256&h=256&q=80" alt="">
                            <div class="ml-4 flex-1 min-w-0">
                                <div class="flex items-center justify-between">
                                    <div class="text-sm text-gray-500">
                                        <span class="font-medium text-gray-900">Jane Smith</span> • asked at 09:00
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button class="vote-btn" data-count="8" aria-pressed="false" title="Upvote">
                                            <i data-feather="thumbs-up" class="h-4 w-4"></i>
                                            <span class="vote-count">8</span>
                                        </button>
                                        <button class="btn-icon" title="Copy link"><i data-feather="link-2"></i></button>
                                        <button class="btn-icon mark-answer hidden" title="Mark as answer"><i data-feather="check-circle"></i></button>
                                    </div>
                                </div>

                                <div class="prose prose-indigo max-w-none mt-3">
                                    <p>I'm struggling to understand how recursion unwinds. For example, with this factorial:</p>
<pre><code class="language-python">def fact(n):
    if n == 0:
        return 1
    return n * fact(n-1)</code></pre>
                                    <p>How does the call stack look for <code>fact(4)</code>?</p>
                                </div>

                                <div class="mt-3 flex items-center gap-2">
                                    <span class="tag">Python</span>
                                    <span class="tag">Recursion</span>
                                    <span class="tag">CS101</span>
                                </div>
                            </div>
                        </div>
                    </article>

                    <!-- Accepted Answer (appears when chosen) -->
                    <div id="accepted-container" class="px-6 pb-6 hidden">
                        <div class="accepted-card">
                            <div class="accepted-header">
                                <i data-feather="check-circle" class="h-4 w-4"></i>
                                <span class="ml-2 font-medium">Accepted answer</span>
                            </div>
                            <div id="accepted-body" class="mt-4"></div>
                        </div>
                    </div>

                    <!-- Replies -->
                    <ul id="thread-list" class="divide-y divide-gray-200">
                        <!-- Reply 1 -->
                        <li class="p-6 post-card reply" data-post-id="a1">
                            <div class="flex">
                                <img class="h-10 w-10 rounded-full" src="https://images.unsplash.com/photo-1519244703995-f4e0f30006d5?auto=format&fit=facearea&w=256&h=256&q=80" alt="">
                                <div class="ml-4 flex-1 min-w-0">
                                    <div class="flex items-center justify-between">
                                        <div class="text-sm text-gray-500">
                                            <span class="font-medium text-gray-900">Alex Johnson</span> • answered at 09:10
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <button class="vote-btn" data-count="5" aria-pressed="false" title="Upvote">
                                                <i data-feather="thumbs-up" class="h-4 w-4"></i>
                                                <span class="vote-count">5</span>
                                            </button>
                                            <button class="btn-icon mark-answer" title="Mark as answer"><i data-feather="check-circle"></i></button>
                                        </div>
                                    </div>
                                    <div class="prose prose-indigo max-w-none mt-3">
                                        <p>Each call waits for the next one to return. For <code>fact(4)</code>, think:</p>
<pre><code>fact(4)
= 4 * fact(3)
= 4 * (3 * fact(2))
= 4 * (3 * (2 * fact(1)))
= 4 * (3 * (2 * (1 * fact(0))))
= 4 * 3 * 2 * 1 * 1</code></pre>
                                        <p>The stack frames unwind from <code>fact(0)</code> upward.</p>
                                    </div>
                                </div>
                            </div>
                        </li>

                        <!-- Reply 2 -->
                        <li class="p-6 post-card reply" data-post-id="a2">
                            <div class="flex">
                                <img class="h-10 w-10 rounded-full" src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=facearea&w=256&h=256&q=80" alt="">
                                <div class="ml-4 flex-1 min-w-0">
                                    <div class="flex items-center justify-between">
                                        <div class="text-sm text-gray-500">
                                            <span class="font-medium text-gray-900">You</span> • answered at 09:20
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <button class="vote-btn" data-count="1" aria-pressed="false" title="Upvote">
                                                <i data-feather="thumbs-up" class="h-4 w-4"></i>
                                                <span class="vote-count">1</span>
                                            </button>
                                            <button class="btn-icon mark-answer" title="Mark as answer"><i data-feather="check-circle"></i></button>
                                        </div>
                                    </div>
                                    <div class="prose prose-indigo max-w-none mt-3">
                                        <p>Another way: add prints to see the order:</p>
<pre><code class="language-python">def fact(n):
    print("enter", n)
    if n == 0:
        print("return 1")
        return 1
    out = n * fact(n-1)
    print("return", out)
    return out</code></pre>
                                    </div>
                                </div>
                            </div>
                        </li>

                        <!-- Reply 3 (hidden by default for "show more") -->
                        <li class="p-6 post-card reply hidden" data-post-id="a3">
                            <div class="flex">
                                <img class="h-10 w-10 rounded-full" src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=facearea&w=256&h=256&q=80" alt="">
                                <div class="ml-4 flex-1 min-w-0">
                                    <div class="flex items-center justify-between">
                                        <div class="text-sm text-gray-500">
                                            <span class="font-medium text-gray-900">Dr. Sarah Johnson</span> • answered at 10:00
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <button class="vote-btn" data-count="2" aria-pressed="false" title="Upvote">
                                                <i data-feather="thumbs-up" class="h-4 w-4"></i>
                                                <span class="vote-count">2</span>
                                            </button>
                                            <button class="btn-icon mark-answer" title="Mark as answer"><i data-feather="check-circle"></i></button>
                                        </div>
                                    </div>
                                    <div class="prose prose-indigo max-w-none mt-3">
                                        <p>Also note the base case must be reached (<code>n==0</code>) to stop recursion.</p>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>

                    <!-- Show more -->
                    <div class="px-6 pb-4">
                        <button id="show-more-replies" class="btn-secondary w-full">
                            <i data-feather="chevron-down" class="mr-2 h-4 w-4"></i>
                            Show more replies
                        </button>
                    </div>

                    <!-- Reply editor -->
                    <form id="reply-form" class="border-t border-gray-200 p-4">
                        <div class="flex items-start gap-3">
                            <img class="h-10 w-10 rounded-full" src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?auto=format&fit=facearea&facepad=2&w=256&h=256&q=80" alt="">
                            <div class="flex-1">
                                <textarea id="reply-input" rows="3" placeholder="Write your reply…" class="w-full border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"></textarea>
                                <div class="mt-3 flex justify-between items-center">
                                    <div class="flex items-center gap-2 text-gray-500">
                                        <button type="button" class="btn-icon" title="Attach"><i data-feather="paperclip"></i></button>
                                        <button type="button" class="btn-icon" title="Code block"><i data-feather="code"></i></button>
                                        <button type="button" class="btn-icon" title="Quote"><i data-feather="quote"></i></button>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button id="reply-cancel" type="button" class="btn-secondary">Cancel</button>
                                        <button id="reply-send" type="submit" class="btn-primary disabled:opacity-50 disabled:cursor-not-allowed">
                                            <i data-feather="send" class="mr-2 h-4 w-4"></i> Post reply
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Sidebar -->
            <aside class="lg:col-span-3 mt-6 lg:mt-0">
                <div class="bg-white shadow rounded-lg overflow-hidden">
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">Topic Info</h3>
                    </div>
                    <div class="p-4 space-y-3">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">Module</span>
                            <span class="font-medium text-gray-900">CS101</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">Created</span>
                            <span class="font-medium text-gray-900">Today, 09:00</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500 text-sm">Tags:</span>
                            <div class="flex flex-wrap gap-2">
                                <span class="tag">Python</span>
                                <span class="tag">Recursion</span>
                                <span class="tag">Basics</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white shadow rounded-lg overflow-hidden mt-6">
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">Participants</h3>
                    </div>
                    <ul class="p-4 space-y-3">
                        <li class="flex items-center">
                            <img class="h-8 w-8 rounded-full" src="https://images.unsplash.com/photo-1519244703995-f4e0f30006d5?auto=format&fit=facearea&w=256&h=256&q=80" alt="">
                            <span class="ml-3 text-sm text-gray-900">Alex Johnson</span>
                        </li>
                        <li class="flex items-center">
                            <img class="h-8 w-8 rounded-full" src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=facearea&w=256&h=256&q=80" alt="">
                            <span class="ml-3 text-sm text-gray-900">Jane Smith</span>
                        </li>
                        <li class="flex items-center">
                            <img class="h-8 w-8 rounded-full" src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=facearea&w=256&h=256&q=80" alt="">
                            <span class="ml-3 text-sm text-gray-900">Dr. Sarah Johnson</span>
                        </li>
                    </ul>
                </div>

                <div class="bg-white shadow rounded-lg overflow-hidden mt-6">
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">Related Topics</h3>
                    </div>
                    <ul class="p-4 space-y-2 text-sm">
                        <li><a href="/topics/detail" class="text-blue-600 hover:text-blue-500">Base cases &amp; infinite recursion</a></li>
                        <li><a href="/topics/detail" class="text-blue-600 hover:text-blue-500">Recursion vs iteration</a></li>
                        <li><a href="/topics/detail" class="text-blue-600 hover:text-blue-500">Tail recursion in Python</a></li>
                    </ul>
                </div>
            </aside>
        </div>
    </div>
</div>

@code {
    [Inject] TopicService TopicService { get; set; } = default!;

    [Parameter, SupplyParameterFromQuery(Name = "topicId")] public int TopicId { get; set; }
    [Parameter, SupplyParameterFromQuery(Name = "studentId")] public int StudentId { get; set; }

    bool subscribing;
    async Task SubscribeCurrentTopic()
    {
        if (TopicId <= 0 || StudentId <= 0) return;
        try
        {
            subscribing = true;
            await TopicService.Subscribe(StudentId, TopicId);
        }
        finally { subscribing = false; }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("ui.initFeather");           // icons
            await JS.InvokeVoidAsync("ui.wireDashboardMenu");     // mobile menu toggle
            await JS.InvokeVoidAsync("ui.wireTopicDetailPage");   // topic interactions
        }
    }
}
